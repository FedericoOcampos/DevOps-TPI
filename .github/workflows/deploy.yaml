# .github/workflows/deploy.yml
name: ğŸš€ Deploy to Render

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Servicio a desplegar'
        required: true
        default: 'detectar-cambios'
        type: choice
        options:
        - detectar-cambios
        - api
        - web
        - todos

jobs:
  # ğŸ” Detectar cambios automÃ¡ticamente
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.changes.outputs.api }}
      web-changed: ${{ steps.changes.outputs.web }}
      infra-changed: ${{ steps.changes.outputs.infra }}
      force-api: ${{ steps.manual.outputs.force-api }}
      force-web: ${{ steps.manual.outputs.force-web }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: ğŸ” Detectar cambios en archivos
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            api:
              - 'api/**'
            web:
              - 'web/**'
            infra:
              - 'render.yaml'
              - 'docker-compose.yml'
              - '.github/workflows/**'

      - name: ğŸ¯ Verificar deploy manual
        id: manual
        run: |
          if [[ "${{ github.event.inputs.service }}" == "api" ]] || [[ "${{ github.event.inputs.service }}" == "todos" ]]; then
            echo "force-api=true" >> $GITHUB_OUTPUT
          else
            echo "force-api=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "${{ github.event.inputs.service }}" == "web" ]] || [[ "${{ github.event.inputs.service }}" == "todos" ]]; then
            echo "force-web=true" >> $GITHUB_OUTPUT
          else
            echo "force-web=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“‹ Mostrar cambios detectados
        run: |
          echo "ğŸ” Cambios detectados:"
          echo "  â€¢ API: ${{ steps.changes.outputs.api }}"
          echo "  â€¢ Web: ${{ steps.changes.outputs.web }}"
          echo "  â€¢ Infraestructura: ${{ steps.changes.outputs.infra }}"
          echo "ğŸ¯ Deploy forzado:"
          echo "  â€¢ Force API: ${{ steps.manual.outputs.force-api }}"
          echo "  â€¢ Force Web: ${{ steps.manual.outputs.force-web }}"

  # ğŸš€ Deploy API
  deploy-api:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.api-changed == 'true' || 
      needs.detect-changes.outputs.infra-changed == 'true' ||
      needs.detect-changes.outputs.force-api == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploying API to Render
        run: |
          echo "ğŸ”„ Iniciando deploy de API..."
          echo "Service ID: ${{ secrets.RENDER_API_SERVICE_ID }}"
          
      - name: ğŸ“¡ Trigger API Deploy
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://api.render.com/v1/services/${{ secrets.RENDER_API_SERVICE_ID }}/deploys'
          method: 'POST'
          customHeaders: |
            {
              "Authorization": "Bearer ${{ secrets.RENDER_API_KEY }}",
              "Content-Type": "application/json"
            }
          data: |
            {
              "clearCache": true
            }
          
      - name: âœ… API Deploy Status
        run: echo "âœ… API deployment triggered successfully!"

  # ğŸŒ Deploy Web
  deploy-web:
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.web-changed == 'true' || 
      needs.detect-changes.outputs.force-web == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploying Web to Render
        run: |
          echo "ğŸ”„ Iniciando deploy de Web..."
          echo "Service ID: ${{ secrets.RENDER_WEB_SERVICE_ID }}"
          
      - name: ğŸ“¡ Trigger Web Deploy
        uses: fjogeleit/http-request-action@v1
        with:
          url: 'https://api.render.com/v1/services/${{ secrets.RENDER_WEB_SERVICE_ID }}/deploys'
          method: 'POST'
          customHeaders: |
            {
              "Authorization": "Bearer ${{ secrets.RENDER_API_KEY }}",
              "Content-Type": "application/json"
            }
          data: |
            {
              "clearCache": true
            }
          
      - name: âœ… Web Deploy Status
        run: echo "âœ… Web deployment triggered successfully!"

  # ğŸ“Š NotificaciÃ³n final
  notify:
    needs: [detect-changes, deploy-api, deploy-web]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "ğŸ¯ Resumen del Deploy:"
          echo "======================================"
          echo "ğŸ“ Cambios detectados:"
          echo "  â€¢ API: ${{ needs.detect-changes.outputs.api-changed }}"
          echo "  â€¢ Web: ${{ needs.detect-changes.outputs.web-changed }}"
          echo "  â€¢ Infraestructura: ${{ needs.detect-changes.outputs.infra-changed }}"
          echo ""
          echo "ğŸš€ Servicios desplegados:"
          echo "  â€¢ API: ${{ needs.deploy-api.result != 'skipped' }}"
          echo "  â€¢ Web: ${{ needs.deploy-web.result != 'skipped' }}"
          echo ""
          echo "âœ… Deploy completado!"